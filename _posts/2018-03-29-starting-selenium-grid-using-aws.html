---
layout: post
title: Starting a Selenium Grid using AWS + SeleniumHQ Docker images + Docker Compose
date: '2018-03-29T09:08:00.002-04:00'
author: T.J. Maher
tags: 
modified_time: '2018-03-29T09:08:47.071-04:00'
blogger_id: tag:blogger.com,1999:blog-3868566217808655382.post-3083532744552101704
blogger_orig_url: http://www.tjmaher.com/2018/03/starting-selenium-grid-using-aws.html
---

With this blog post we will be exploring how to start a Selenium Grid using an Amazon Web Service (AWS) instance the SeleniumHQ Docker images, Docker and Docker Compose. For this example, I will be using a Macbook, so the Terminal will be my Command Line Interface.<br /><br />Need more information? Check out the official Amazon Web Services documentation:<br /><ul><li><a href="https://aws.amazon.com/docker/" target="_blank">What is Docker?</a> </li><li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" target="_blank">What is an Amazon Machine Image (AMI)</a> </li><li><a href="https://aws.amazon.com/amazon-linux-ami/faqs/" target="_blank">Amazon Linux AMI FAQ</a></li><li><a href="https://docs.docker.com/engine/docker-overview/" target="_blank">Docker overview</a></li></ul>We could use the "<a href="https://aws.amazon.com/ecs/" target="_blank">Amazon Elastic Container Service</a>" and using <a href="https://aws.amazon.com/fargate/" target="_blank">AWS Fargate</a> to run containers without managing servers or clusters ... but since I am tinkering, I want to make sure that I am using only free services provided by the Amazon Free Tier that I signed up for last month.<br /><br />We are going to be starting off by following along with the official docs by Amazon, <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/docker-basics.html" target="_blank">AWS Docker Basics</a>. <br /><a name='more'></a><br /><h3>Start up an AWS EC2 Instance</h3>First, we are going to go to <a href="http://aws.amazon.com/" target="_blank">AWS.Amazon.Com</a> and sign in. <br /><br />Once on the dashboard, select "Launch a Virtual Machine".<br /><br /><u><b>Choose an Amazon Machine Image (AMI)</b></u><br /><br />I made sure to check off "Free Tier Only" checkbox. I don't want to accidentally incure a bill. <br /><br />I chose first Amazon Machine Image, Amazon Linux AMI version 2017.09.1 (HVM), SSD Volume Type , 64 bit. <br /><ul><li>The info for this machine reads: "The default image includes AWS command line tools, Python, Ruby, Perl, and Java. The repositories include Docker, PHP, MySQL, PostgreSQL, and other packages."&nbsp;</li></ul>Press the Select Button.<br /><br /><u><b>Choose Instance type </b></u><br /><br />I chose General purpose, t2.micro.<br /><ul><li>The info for "General Purpose": "General purpose instances provide a balance of compute, memory, and network resources, and are a good choice for many applications. They are recommended for small and medium databases, data processing tasks that require additional memory, caching fleets, and for running backend servers for SAP, Microsoft SharePoint, and other enterprise applications."</li><li>The info for "T2" reads: "T2 instances provide a baseline level of CPU performance with the ability to burst above the baseline.The baseline and ability to burst are governed by CPU Credits. The t2.micro receives CPU Credits continuously at a rate of 6 CPU Credits per hour. To learn more about Amazon EC2 T2 instances, see the Amazon EC2 details page".</li></ul><br />From here, I selected "Review and Launch" and "Launch".<br /><br /><u><b>Creating a key pair</b></u><br /><br />I chose to create a new key pair, naming it "tjmaher-test". Selecting "Download Key Pair", saved the private key tjmaher-test.pem to my local machine. <br /><br />"A key pair consists of a public key that AWS stores, and a private key file that you store. Together, they allow you to connect to your instance securely. For Windows AMIs, the private key file is required to obtain the password used to log into your instance. For Linux AMIs, the private key file allows you to securely SSH into your instance".<br /><br />"A key pair consists of a public key that AWS stores, and a private key file that you store. Together, they allow you to connect to your instance securely. For Windows AMIs, the private key file is required to obtain the password used to log into your instance. For Linux AMIs, the private key file allows you to securely SSH into your instance".<br /><br /><br /><br /><u><b>Confirm the AWS Instance is Running</b></u><br /><br />To view the AMI instance that was created, go to AWS -&gt; Services -&gt; EC2 to get to the EC2 Dashboard, and select the link for "Running Instances"<br /><br />You can see that it is running. Hrm... refering to it by instance id would be a bit much. Let's click on the blank space under the name and call it "grid".<br /><br /><h3>Allow Outside Automation Toolsets to Connect to the Selenium Grid</h3><br />How will outside toolsets access the AWS instance connect to this Selenium Grid we will be running?<br /><br />Selenium Grid uses port "4444". For this demo, we will be opening that port for the public IP address.<br /><br />But how do you find this public&nbsp; IP address?<br /><ul><li>On the AWS Console, go to Actions -&gt; Networking -&gt; Manage IP addresses.</li></ul>"You can assign and unassign IPv4 and IPv6 IP addresses on each network interface. Leave the IP address field blank and an available address will be assigned or enter an IP address that you want to assign.<br /><br />"To add or edit an IPv4 public IP Allocate an Elastic IP to this instance or network interface".<br /><br />It shows two IP addresses: <br /><ul><li>Private IP: 172.31.26.200&nbsp; </li><li>Public IP    : 54.201.124.200    </li></ul>... Note these are not the real IP addresses that were given. As much as I like my blog readers, I don't want you connecting to my Selenium Grid. <br /><br />We are going to open up port 4444 on that Public IP by adding a new rule to that security group to allow inbound traffic.<br /><br /><u><b>But What Is a Security Group? </b></u><br /><br />According to <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html" target="_blank">Amazon EC2 Security Groups for Linux Instances</a>: "A security group acts as a virtual firewall that controls the traffic for one or more instances. When you launch an instance, you associate one or more security groups with the instance. You add rules to each security group that allow traffic to or from its associated instances. You can modify the rules for a security group at any time; the new rules are automatically applied to all instances that are associated with the security group after a short period. When we decide whether to allow traffic to reach an instance, we evaluate all the rules from all the security groups that are associated with the instance."<br /><br />We are going to add a rule that port 4444 is fine for inbound traffic.<br /><br />Following the instructions for Amazon's doc, <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html#adding-security-group-rule" target="_blank">Adding Rules to a Security Group</a>: <br /><br />1) Open the Amazon EC2 console at https://console.aws.amazon.com/ec2/<br />2) In the navigation pane, choose the Security Groups link. <br />3) Select the Inbound tab, choose Edit.<br />4) In the dialog, choose Add Rule and do the following:<br /><ul><li>Type: Custom TCP</li><li>Protocol: TCP</li><li>Part Range: 4444</li><li>Source: My IP</li><li>Description: Selenium Grid</li></ul><br />Once the Selenium Grid is up and running, if 54.201.124.200 is the public facing IP addresss, connecting to http://54.201.124.200:4444/grid/console will connect to the console.<br /><br /><h3>How To Connect to Our AWS Instance</h3><br />How do we connect through the command line to this AWS instance we are creating? To see how, press the "Connect" button on the AWS Dashboard. <br /><br />"To access your instance:<br />"Open an SSH client. <i>(We will be using the Mac Terminal)</i><br />"Locate your private key file <i>(tjmaher-test.pem)</i>. The wizard automatically detects the key you used to launch the instance.<br />"Your key must not be publicly viewable for SSH to work. Use this command if needed:<br />"chmod 400 tjmaher-test.pem<br /><br />"Connect to your instance using its Public DNS:<br />ec2-1234.compute.amazonaws.com<br /><br />"Example: ssh -i "tjmaher-test.pem" ec2-user@1234.us-west-2.compute.amazonaws.com<br /><br />"Please note that in most cases the username above will be correct, however please ensure that you read your AMI usage instructions to ensure that the AMI owner has not changed the default AMI username.<br /><br />"If you need any assistance connecting to your instance, please see our connection documentation".<br /><br />Following the instructions, we can connect to the AWS instance.<br /><br />Opening up the Mac Terminal we can ssh into the machine: <i>ssh -i "tjmaher-test.pem" ec2-user@1234.us-west-2.compute.amazonaws.com</i><br /><br /><br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">     __| __|_ )  <br />     _| (   /  Amazon Linux AMI  <br />    ___|\___|___|  <br />   <br /> https://aws.amazon.com/amazon-linux-ami/2017.09-release-notes/  <br /> 2 package(s) needed for security, out of 5 available  <br /> Run "sudo yum update" to apply all updates.  <br /> [ec2-user@ip-172-31-26-200 ~]$  <br /></code></pre><br /><br />Let's do that, updating the image: <i>sudo yum update </i><br /><br /><h3>Install Docker on an Amazon Linux instance</h3><br />Now, let's continue following the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/docker-basics.html" target="_blank">AWS guide on Docker Basics</a>. <br /><br />We have completed the first two steps, <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/launching-instance.html" target="_blank">launching an AWS instance</a>&nbsp; and <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html" target="_blank">connecting to your Linux instance</a>. <br /><br />Following the Amazon instructions for <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/docker-basics.html" target="_blank">Docker Basics</a>: <br /><ul><li>Install Docker on the AWS instance: <i>sudo yum install -y docker</i></li><li>Start the docker service: sudo service docker start</li><li>Add the ec-2-user to the Docker group: <i>sudo usermod -a -G docker ec2-user</i></li><li>Close the Mac Terminal and reopen it to reset permissions.</li></ul>Is Docker installed? We can see <br /><br />Containers: 0<br />Running: 0<br />Paused: 0<br />Stopped: 0<br />Images: 0<br /><br />How does Docker know how to get something running in its container? It uses a special file called a Dockerfile. What is a Dockerfile? From the <a href="https://docs.docker.com/engine/reference/builder/" target="_blank">Docker Reference: Builder</a>: "Docker can build images automatically by reading the instructions from a Dockerfile. A Dockerfile is a text document that contains all the commands a user could call on the command line to assemble an image. Using docker build users can create an automated build that executes several command-line instructions in succession."<br /><h3></h3><h3>Start Up a Selenium Grid Using SeleniumHQ Docker Images</h3><br />To start up a Selenium Grid, we are going to use pre-written Docker images that the Selenium HQ people are already using. They are stored publicly at Docker Hub at <a href="https://hub.docker.com/u/selenium/" target="_blank">https://hub.docker.com/u/selenium/</a>.<br /><br />We are going to be following along the official SeleniumHQ instructions from their Docker-Selenium site at <a href="https://github.com/SeleniumHQ/docker-selenium" target="_blank">https://github.com/SeleniumHQ/docker-selenium.</a><br /><br />For this demo, the Docker images we will be using:<br /><ul><li><b>selenium/hub</b>: Image for running a Grid Hub.  It will expose port 4444 on the AWS instance so we can connect to the Selenium Grid. </li><li><b>selenium/node-chrome</b>: Grid Node with Chrome installed, needs to be connected to a Grid Hub</li><li><b>selenium/node-firefox</b>: Grid Node with Firefox installed, needs to be connected to a Grid Hub</li></ul>According to Selenium HQ's instructions, you need to create a <a href="https://docs.docker.com/engine/reference/commandline/network_create/" target="_blank">Docker Network</a> <br /><br /><i>$ docker network create grid</i><br /><i>$ docker run -d -p 4444:4444 --net grid --name selenium-hub selenium/hub:3.11.0-bismuth</i><br /><i>$ docker run -d --net grid -e HUB_HOST=selenium-hub -v /dev/shm:/dev/shm selenium/node-chrome:3.11.0-bismuth</i><br /><i>$ docker run -d --net grid -e HUB_HOST=selenium-hub -v /dev/shm:/dev/shm selenium/node-firefox:3.11.0-bismuth</i><br /><br />A better way?<br /><ul><li>Docker Compose: <a href="https://docs.docker.com/compose/overview/" target="_blank">https://docs.docker.com/compose/overview/</a></li><li>Docker Compose GitHub: <a href="https://github.com/docker/compose" target="_blank">https://github.com/docker/compose</a> </li></ul><br />"Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your application’s services. Then, with a single command, you create and start all the services from your configuration."<br /><br />Once you have a Docker Compose file, to start and stop the Selenium Grid. <br /><br />$ docker-compose up -d<br />$ docker-compose down<br /><br />Where would you find such a file? Selenium HQ! The <a href="https://github.com/SeleniumHQ/docker-selenium" target="_blank">instructions we have been reviewing</a> has one for you:<br /><br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> # To execute this docker-compose yml file use docker-compose -f &lt;file_name&gt; up  <br /> # Add the "-d" flag at the end for deattached execution  <br /> version: '2'  <br /> services:  <br />  firefox:  <br />   image: selenium/node-firefox:3.11.0-bismuth  <br />   volumes:  <br />    - /dev/shm:/dev/shm  <br />   depends_on:  <br />    - hub  <br />   environment:  <br />    HUB_HOST: hub  <br />   <br />  chrome:  <br />   image: selenium/node-chrome:3.11.0-bismuth  <br />   volumes:  <br />    - /dev/shm:/dev/shm  <br />   depends_on:  <br />    - hub  <br />   environment:  <br />    HUB_HOST: hub  <br />   <br />  hub:  <br />   image: selenium/hub:3.11.0-bismuth  <br />   ports:  <br />    - "4444:4444"  <br /></code></pre><br />"To stop the grid and cleanup the created containers, run <i>docker-compose down</i>".<br /><br />Since we are tinkering, we will have the Hub and Nodes on the same machine. Note, it does not have to be this way! You can attach any node to the Hub.<br /><br /><h3>Install Docker Compose </h3><br />Now that we have Docker, let's install Docker Compose on the AWS instance we have running.<br /><br />Let's use the official documentation for <b>Install Docker Compose</b> at <a href="https://docs.docker.com/compose/install/" target="_blank">https://docs.docker.com/compose/install/</a><br /><br />According to the documentation, you can use curl to install it. <br /><br /><i>sudo curl -L https://github.com/docker/compose/releases/download/1.20.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</i><br /><br />Let's apply executable permissions:<i> sudo chmod +x /usr/local/bin/docker-compose</i><br />Test to see if Docker Compose is working: <i>docker-compose --version</i><br /><br />Our output:<br /><ul><li>docker-compose version 1.20.1, build 5d8c71b</li></ul>... Yes, it is working!<br /><br /><h3>Create the Docker Compose File</h3><br />Now that we have Docker Compose up and running, let's create a docker-compose.yml file out of the text that SeleniumHQ gave us. <br /><ul><li>Go back to Mac Terminal you have running. </li><li>Check that you are still ssh'ed into the AWS instance.</li><li>Create a new blank file: <i>touch docker-compose.yml</i></li></ul>Did it work? List what is in the directory: <i>ls</i><br /><br />Let's edit the file in the nano text editor: <i>nano docker-compose.yml</i><br /><ul><li>Copy and paste the Docker Compose file into this file.</li><li>^X (Control + X) will exit Nano.</li><li>Y to save the file.</li><li>Enter to close nano.</li><li>Brought back to to the main command line.</li></ul>Did it save? Let's print the file to the screen: <i>cat docker-compose.yml</i><br /><br /><h3>Docker Compose Up!<i> </i></h3><br />Now, let's type the magic words: <i>docker-compose up -d</i><br /><br />... Adding the -d flag runs Docker in detached mode so we can go onto other things after kicking it off.&nbsp; <br /><br />When we run this command, all Docker files are being pulled from the Docker Hub, downloaded, extracted, and installed into Docker on our AWS instance. <br /><br />What is being set up?<br /><ul><li>hub_1</li><li>firefox_1</li><li>chrome_1</li></ul><br /><br /><pre style="background: #f0f0f0; border: 1px dashed #cccccc; color: black; font-family: &quot;arial&quot;; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> hub_1   | 20:55:49.994 INFO [Hub.start] - Selenium Grid hub is up and running  <br /> firefox_1 | 2018-03-28 20:55:49.866:INFO::main: Logging initialized @2148ms to org.seleniumhq.jetty9.util.log.StdErrLog  <br /> chrome_1  | 2018-03-28 20:55:49.879:INFO::main: Logging initialized @2163ms to org.seleniumhq.jetty9.util.log.StdErrLog  <br /> hub_1   | 20:55:49.994 INFO [Hub.start] <br />- Selenium Grid hub is up and running  <br /> hub_1   | 20:55:49.995 INFO [Hub.start] <br />- Nodes should register to http://172.18.0.0:4444/grid/register/  <br /> hub_1   | 20:55:49.996 INFO [Hub.start] <br />- Clients should connect to http://172.18.0.0:4444/wd/hub  <br />   <br /> Selenium Server is running  <br />   <br /> hub_1   | 20:55:51.787 INFO [DefaultGridRegistry.add] - Registered a node http://172.18.0.0:5555  <br /> hub_1   | 20:55:51.788 INFO [DefaultGridRegistry.add] - Registered a node http://172.18.0.0:5555  <br /> chrome_1  | 20:55:51.994 INFO [SelfRegisteringRemote.registerToHub] - The node is registered to the hub and ready to use  <br /> firefox_1 | 20:55:52.017 INFO [SelfRegisteringRemote.registerToHub] - The node is registered to the hub and ready to use  <br /></code></pre><br /><br />Need 5 more instances of Chrome?  With Docker you can scale up or down depending on what you need: <i>docker-compose scale chrome=5</i><br /><br />Now, all I needed to do is go to http://54.201.124.200:4444/grid/console to see a perfectly running Selenium Grid!<br /><br />... Of course, you wouldn't use that. You would access the selenium-grid console using http://{YOUR_HOST}:4444/grid/console ... <br /><br />Next, I need to add Safari to the mix... anyone know how to do that?<br /><br />Oh, and before I forget, I need to change the external IP address. I think I changed the digits of the external IP enough? Not sure. I don't want the world connecting to it. <br /><br />Happy Testing! <br /><br />-T.J. Maher<br />Sr. QA Engineer, Software Engineer in Test<br />Meetup Organizer, <a href="http://bit.ly/mot_boston" target="_blank">Ministry of Testing - Boston</a><br /><br /><a href="https://twitter.com/tjmaher1">Twitter</a>&nbsp;| <a href="http://bit.ly/tj_youtube" target="_blank">YouTube</a> |&nbsp;<a href="https://www.linkedin.com/in/tjmaher1" target="_blank">LinkedIn</a>&nbsp;| <a href="http://bit.ly/tj_techbeacon" target="_blank">Articles</a>